rng('default')
a=(1:3);
b=zeros(1,length(a));

for k=1:length(a)
b(k)=convertStringsToChars(num2str(a(k)));
end
b

clc
close all
clear
load ('USA_data.mat');
D=contactMatrix*100;
N=agDist;

gamma=1.1;
epsilon=0.1;
k=length(N);
 v=0.2;
 i0=zeros(k,1)+1e-6;
 v0=zeros(k,1)+v/k; % initial guess
v0(3)=0;
v0(4)=0;
v0(5)=0;

lb=zeros(k,1);
ub=N-i0;
%ub=N;
A=[];
b=[];
Aeq = [ones(1,k);1 0 0 0 0 0 0 0 0];
beq = [v;0.12];
%Aeq=ones(1,k);
%beq=v;
B=[]
C=[];
betalim=[14];
 options=optimset('fmincon');
options=optimset(options,'TolCon',1e-8,'TolX',1e-8,'TolFun',1e-8);
                     
for beta=betalim
x = fmincon(@(v0) maxfuncI(v0,beta, gamma,epsilon,D,N,k,i0),v0,A,b,Aeq,beq,lb,ub,[],options);
%B=[B x./(N-i0)];
B=[B x./min((N-i0)*0+v,N-i0)];
end
% Create axes

figure()
imagesc(B);
for j=1:5
xline(j+0.5);
yline(j+0.5);
end
for a=1:size(B,1)
    for b=1:size(B,2)
        text(b,a,num2str(round(B(a,b),2)),'FontSize', 8)
    end
end

yticks([1:k]);
xticks([1:6]);
xticklabels({'7','7.5','8','8.5','9','9.5'})
xlabel('\beta');
ylabel('$$\vec{v}  $$','interpreter','latex');
 hYLabel = get(gca,'YLabel');
 set(hYLabel,'rotation',0,'VerticalAlignment','middle');
title('Optimal allocation','interpreter','latex');

colormap(...
    [0.650980392156863 0.650980392156863 0.650980392156863;0.652349096501346 0.652349096501346 0.652349096501346;0.653717800845829 0.653717800845829 0.653717800845829;0.655086505190311 0.655086505190311 0.655086505190311;0.656455209534794 0.656455209534794 0.656455209534794;0.657823913879277 0.657823913879277 0.657823913879277;0.65919261822376 0.65919261822376 0.65919261822376;0.660561322568243 0.660561322568243 0.660561322568243;0.661930026912726 0.661930026912726 0.661930026912726;0.663298731257209 0.663298731257209 0.663298731257209;0.664667435601692 0.664667435601692 0.664667435601692;0.666036139946175 0.666036139946175 0.666036139946175;0.667404844290657 0.667404844290657 0.667404844290657;0.66877354863514 0.66877354863514 0.66877354863514;0.670142252979623 0.670142252979623 0.670142252979623;0.671510957324106 0.671510957324106 0.671510957324106;0.672879661668589 0.672879661668589 0.672879661668589;0.674248366013072 0.674248366013072 0.674248366013072;0.675617070357555 0.675617070357555 0.675617070357555;0.676985774702038 0.676985774702038 0.676985774702038;0.678354479046521 0.678354479046521 0.678354479046521;0.679723183391003 0.679723183391003 0.679723183391003;0.681091887735486 0.681091887735486 0.681091887735486;0.682460592079969 0.682460592079969 0.682460592079969;0.683829296424452 0.683829296424452 0.683829296424452;0.685198000768935 0.685198000768935 0.685198000768935;0.686566705113418 0.686566705113418 0.686566705113418;0.687935409457901 0.687935409457901 0.687935409457901;0.689304113802384 0.689304113802384 0.689304113802384;0.690672818146867 0.690672818146867 0.690672818146867;0.69204152249135 0.69204152249135 0.69204152249135;0.693410226835832 0.693410226835832 0.693410226835832;0.694778931180315 0.694778931180315 0.694778931180315;0.696147635524798 0.696147635524798 0.696147635524798;0.697516339869281 0.697516339869281 0.697516339869281;0.698885044213764 0.698885044213764 0.698885044213764;0.700253748558247 0.700253748558247 0.700253748558247;0.70162245290273 0.70162245290273 0.70162245290273;0.702991157247213 0.702991157247213 0.702991157247213;0.704359861591696 0.704359861591696 0.704359861591696;0.705728565936178 0.705728565936178 0.705728565936178;0.707097270280661 0.707097270280661 0.707097270280661;0.708465974625144 0.708465974625144 0.708465974625144;0.709834678969627 0.709834678969627 0.709834678969627;0.71120338331411 0.71120338331411 0.71120338331411;0.712572087658593 0.712572087658593 0.712572087658593;0.713940792003076 0.713940792003076 0.713940792003076;0.715309496347559 0.715309496347559 0.715309496347559;0.716678200692042 0.716678200692042 0.716678200692042;0.718046905036524 0.718046905036524 0.718046905036524;0.719415609381007 0.719415609381007 0.719415609381007;0.72078431372549 0.72078431372549 0.72078431372549;0.722153018069973 0.722153018069973 0.722153018069973;0.723521722414456 0.723521722414456 0.723521722414456;0.724890426758939 0.724890426758939 0.724890426758939;0.726259131103422 0.726259131103422 0.726259131103422;0.727627835447905 0.727627835447905 0.727627835447905;0.728996539792388 0.728996539792388 0.728996539792388;0.73036524413687 0.73036524413687 0.73036524413687;0.731733948481353 0.731733948481353 0.731733948481353;0.733102652825836 0.733102652825836 0.733102652825836;0.734471357170319 0.734471357170319 0.734471357170319;0.735840061514802 0.735840061514802 0.735840061514802;0.737208765859285 0.737208765859285 0.737208765859285;0.738577470203768 0.738577470203768 0.738577470203768;0.739946174548251 0.739946174548251 0.739946174548251;0.741314878892734 0.741314878892734 0.741314878892734;0.742683583237217 0.742683583237217 0.742683583237217;0.744052287581699 0.744052287581699 0.744052287581699;0.745420991926182 0.745420991926182 0.745420991926182;0.746789696270665 0.746789696270665 0.746789696270665;0.748158400615148 0.748158400615148 0.748158400615148;0.749527104959631 0.749527104959631 0.749527104959631;0.750895809304114 0.750895809304114 0.750895809304114;0.752264513648597 0.752264513648597 0.752264513648597;0.75363321799308 0.75363321799308 0.75363321799308;0.755001922337562 0.755001922337562 0.755001922337562;0.756370626682045 0.756370626682045 0.756370626682045;0.757739331026528 0.757739331026528 0.757739331026528;0.759108035371011 0.759108035371011 0.759108035371011;0.760476739715494 0.760476739715494 0.760476739715494;0.761845444059977 0.761845444059977 0.761845444059977;0.76321414840446 0.76321414840446 0.76321414840446;0.764582852748943 0.764582852748943 0.764582852748943;0.765951557093426 0.765951557093426 0.765951557093426;0.767320261437909 0.767320261437909 0.767320261437909;0.768688965782391 0.768688965782391 0.768688965782391;0.770057670126874 0.770057670126874 0.770057670126874;0.771426374471357 0.771426374471357 0.771426374471357;0.77279507881584 0.77279507881584 0.77279507881584;0.774163783160323 0.774163783160323 0.774163783160323;0.775532487504806 0.775532487504806 0.775532487504806;0.776901191849289 0.776901191849289 0.776901191849289;0.778269896193772 0.778269896193772 0.778269896193772;0.779638600538255 0.779638600538255 0.779638600538255;0.781007304882737 0.781007304882737 0.781007304882737;0.78237600922722 0.78237600922722 0.78237600922722;0.783744713571703 0.783744713571703 0.783744713571703;0.785113417916186 0.785113417916186 0.785113417916186;0.786482122260669 0.786482122260669 0.786482122260669;0.787850826605152 0.787850826605152 0.787850826605152;0.789219530949635 0.789219530949635 0.789219530949635;0.790588235294118 0.790588235294118 0.790588235294118;0.791956939638601 0.791956939638601 0.791956939638601;0.793325643983083 0.793325643983083 0.793325643983083;0.794694348327566 0.794694348327566 0.794694348327566;0.796063052672049 0.796063052672049 0.796063052672049;0.797431757016532 0.797431757016532 0.797431757016532;0.798800461361015 0.798800461361015 0.798800461361015;0.800169165705498 0.800169165705498 0.800169165705498;0.801537870049981 0.801537870049981 0.801537870049981;0.802906574394464 0.802906574394464 0.802906574394464;0.804275278738947 0.804275278738947 0.804275278738947;0.805643983083429 0.805643983083429 0.805643983083429;0.807012687427912 0.807012687427912 0.807012687427912;0.808381391772395 0.808381391772395 0.808381391772395;0.809750096116878 0.809750096116878 0.809750096116878;0.811118800461361 0.811118800461361 0.811118800461361;0.812487504805844 0.812487504805844 0.812487504805844;0.813856209150327 0.813856209150327 0.813856209150327;0.81522491349481 0.81522491349481 0.81522491349481;0.816593617839293 0.816593617839293 0.816593617839293;0.817962322183776 0.817962322183776 0.817962322183776;0.819331026528258 0.819331026528258 0.819331026528258;0.820699730872741 0.820699730872741 0.820699730872741;0.822068435217224 0.822068435217224 0.822068435217224;0.823437139561707 0.823437139561707 0.823437139561707;0.82480584390619 0.82480584390619 0.82480584390619;0.826174548250673 0.826174548250673 0.826174548250673;0.827543252595156 0.827543252595156 0.827543252595156;0.828911956939639 0.828911956939639 0.828911956939639;0.830280661284121 0.830280661284121 0.830280661284121;0.831649365628604 0.831649365628604 0.831649365628604;0.833018069973087 0.833018069973087 0.833018069973087;0.83438677431757 0.83438677431757 0.83438677431757;0.835755478662053 0.835755478662053 0.835755478662053;0.837124183006536 0.837124183006536 0.837124183006536;0.838492887351019 0.838492887351019 0.838492887351019;0.839861591695502 0.839861591695502 0.839861591695502;0.841230296039985 0.841230296039985 0.841230296039985;0.842599000384468 0.842599000384468 0.842599000384468;0.84396770472895 0.84396770472895 0.84396770472895;0.845336409073433 0.845336409073433 0.845336409073433;0.846705113417916 0.846705113417916 0.846705113417916;0.848073817762399 0.848073817762399 0.848073817762399;0.849442522106882 0.849442522106882 0.849442522106882;0.850811226451365 0.850811226451365 0.850811226451365;0.852179930795848 0.852179930795848 0.852179930795848;0.853548635140331 0.853548635140331 0.853548635140331;0.854917339484814 0.854917339484814 0.854917339484814;0.856286043829296 0.856286043829296 0.856286043829296;0.857654748173779 0.857654748173779 0.857654748173779;0.859023452518262 0.859023452518262 0.859023452518262;0.860392156862745 0.860392156862745 0.860392156862745;0.861760861207228 0.861760861207228 0.861760861207228;0.863129565551711 0.863129565551711 0.863129565551711;0.864498269896194 0.864498269896194 0.864498269896194;0.865866974240677 0.865866974240677 0.865866974240677;0.86723567858516 0.86723567858516 0.86723567858516;0.868604382929642 0.868604382929642 0.868604382929642;0.869973087274125 0.869973087274125 0.869973087274125;0.871341791618608 0.871341791618608 0.871341791618608;0.872710495963091 0.872710495963091 0.872710495963091;0.874079200307574 0.874079200307574 0.874079200307574;0.875447904652057 0.875447904652057 0.875447904652057;0.87681660899654 0.87681660899654 0.87681660899654;0.878185313341023 0.878185313341023 0.878185313341023;0.879554017685506 0.879554017685506 0.879554017685506;0.880922722029988 0.880922722029988 0.880922722029988;0.882291426374471 0.882291426374471 0.882291426374471;0.883660130718954 0.883660130718954 0.883660130718954;0.885028835063437 0.885028835063437 0.885028835063437;0.88639753940792 0.88639753940792 0.88639753940792;0.887766243752403 0.887766243752403 0.887766243752403;0.889134948096886 0.889134948096886 0.889134948096886;0.890503652441369 0.890503652441369 0.890503652441369;0.891872356785852 0.891872356785852 0.891872356785852;0.893241061130335 0.893241061130335 0.893241061130335;0.894609765474817 0.894609765474817 0.894609765474817;0.8959784698193 0.8959784698193 0.8959784698193;0.897347174163783 0.897347174163783 0.897347174163783;0.898715878508266 0.898715878508266 0.898715878508266;0.900084582852749 0.900084582852749 0.900084582852749;0.901453287197232 0.901453287197232 0.901453287197232;0.902821991541715 0.902821991541715 0.902821991541715;0.904190695886198 0.904190695886198 0.904190695886198;0.90555940023068 0.90555940023068 0.90555940023068;0.906928104575163 0.906928104575163 0.906928104575163;0.908296808919646 0.908296808919646 0.908296808919646;0.909665513264129 0.909665513264129 0.909665513264129;0.911034217608612 0.911034217608612 0.911034217608612;0.912402921953095 0.912402921953095 0.912402921953095;0.913771626297578 0.913771626297578 0.913771626297578;0.915140330642061 0.915140330642061 0.915140330642061;0.916509034986544 0.916509034986544 0.916509034986544;0.917877739331026 0.917877739331026 0.917877739331026;0.919246443675509 0.919246443675509 0.919246443675509;0.920615148019992 0.920615148019992 0.920615148019992;0.921983852364475 0.921983852364475 0.921983852364475;0.923352556708958 0.923352556708958 0.923352556708958;0.924721261053441 0.924721261053441 0.924721261053441;0.926089965397924 0.926089965397924 0.926089965397924;0.927458669742407 0.927458669742407 0.927458669742407;0.92882737408689 0.92882737408689 0.92882737408689;0.930196078431373 0.930196078431373 0.930196078431373;0.931564782775856 0.931564782775856 0.931564782775856;0.932933487120338 0.932933487120338 0.932933487120338;0.934302191464821 0.934302191464821 0.934302191464821;0.935670895809304 0.935670895809304 0.935670895809304;0.937039600153787 0.937039600153787 0.937039600153787;0.93840830449827 0.93840830449827 0.93840830449827;0.939777008842753 0.939777008842753 0.939777008842753;0.941145713187236 0.941145713187236 0.941145713187236;0.942514417531719 0.942514417531719 0.942514417531719;0.943883121876201 0.943883121876201 0.943883121876201;0.945251826220684 0.945251826220684 0.945251826220684;0.946620530565167 0.946620530565167 0.946620530565167;0.94798923490965 0.94798923490965 0.94798923490965;0.949357939254133 0.949357939254133 0.949357939254133;0.950726643598616 0.950726643598616 0.950726643598616;0.952095347943099 0.952095347943099 0.952095347943099;0.953464052287582 0.953464052287582 0.953464052287582;0.954832756632065 0.954832756632065 0.954832756632065;0.956201460976547 0.956201460976547 0.956201460976547;0.95757016532103 0.95757016532103 0.95757016532103;0.958938869665513 0.958938869665513 0.958938869665513;0.960307574009996 0.960307574009996 0.960307574009996;0.961676278354479 0.961676278354479 0.961676278354479;0.963044982698962 0.963044982698962 0.963044982698962;0.964413687043445 0.964413687043445 0.964413687043445;0.965782391387928 0.965782391387928 0.965782391387928;0.967151095732411 0.967151095732411 0.967151095732411;0.968519800076894 0.968519800076894 0.968519800076894;0.969888504421376 0.969888504421376 0.969888504421376;0.971257208765859 0.971257208765859 0.971257208765859;0.972625913110342 0.972625913110342 0.972625913110342;0.973994617454825 0.973994617454825 0.973994617454825;0.975363321799308 0.975363321799308 0.975363321799308;0.976732026143791 0.976732026143791 0.976732026143791;0.978100730488274 0.978100730488274 0.978100730488274;0.979469434832757 0.979469434832757 0.979469434832757;0.980838139177239 0.980838139177239 0.980838139177239;0.982206843521722 0.982206843521722 0.982206843521722;0.983575547866205 0.983575547866205 0.983575547866205;0.984944252210688 0.984944252210688 0.984944252210688;0.986312956555171 0.986312956555171 0.986312956555171;0.987681660899654 0.987681660899654 0.987681660899654;0.989050365244137 0.989050365244137 0.989050365244137;0.99041906958862 0.99041906958862 0.99041906958862;0.991787773933103 0.991787773933103 0.991787773933103;0.993156478277585 0.993156478277585 0.993156478277585;0.994525182622068 0.994525182622068 0.994525182622068;0.995893886966551 0.995893886966551 0.995893886966551;0.997262591311034 0.997262591311034 0.997262591311034;0.998631295655517 0.998631295655517 0.998631295655517;1 1 1])
  

ax = gca;
outerpos = ax.OuterPosition;
ti = ax.TightInset; 
left = outerpos(1) + ti(1);
bottom = outerpos(2) + ti(2);
ax_width = outerpos(3) - ti(1) - ti(3);
ax_height = outerpos(4) - ti(2) - ti(4);
ax.Position = [left bottom ax_width ax_height];

function Q=maxfuncI(v0,beta, gamma,epsilon,D,N,k,i0)
s0=N-i0-v0;
y0=[s0;v0;i0];
tspan= [0:1e-5:5];opts = odeset('RelTol',1e-12,'AbsTol',1e-12,'Events', @(t,y) eventfunc(t,y,beta, gamma,epsilon,D,N,k));
[t,y] = ode89(@(t,y) odefcn(t,y,beta, gamma,epsilon,D,N,k), tspan, y0,opts);
%size(t)
%plot(t,sum((y(:,2*k+1:3*k)')))
%hold on
[argvalue, argmax] =max(sum((y(:,2*k+1:3*k)')));
[t,y] = ode45(@(t,y) odefcn(t,y,beta, gamma,epsilon,D,N,k), [0:1e-2:10], y0);
I_tot=sum(y(:,2*k+1:3*k),2);
hold on
plot(t,I_tot)
Q=argvalue
end
function dydt = odefcn(t,y,  beta, gamma,epsilon,D,N,k)

S=y(1:k);
V=y(k+1:2*k);
I=y(2*k+1:3*k);
ds=-beta*S.*(D*I);
dv=-beta*epsilon*V.*(D*I);
di=beta*(S+epsilon*V).*(D*I)-gamma*I;
dydt=[ds;dv;di];
end
function [value,isterminal,direction]=eventfunc(t,y,beta, gamma,epsilon,D,N,k)


S=y(1:k);
V=y(k+1:2*k);
I=y(2*k+1:3*k);
di=beta*(S+epsilon*V).*(D*I)-gamma*I;
value=sum(di);
isterminal=1;
direction=-1;
end










